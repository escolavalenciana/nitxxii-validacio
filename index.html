<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Validació QR — La Nit (Google Sheets)</title>
<style>
  :root{ --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --ink:#0f172a; --muted:#6b7280; --bg:#ffffff; }
  *{box-sizing:border-box;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0; background:var(--bg); color:var(--ink);}
  header{padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; gap:16px; align-items:center; flex-wrap:wrap;}
  header h1{font-size:18px; margin:0; font-weight:700;}
  main{max-width:760px; margin:0 auto; padding:16px;}
  .panel{border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px;}
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .row > *{flex:1 1 320px; min-width:0;}
  label{font-weight:600; font-size:14px; display:block; margin-bottom:6px;}
  input[type="text"], select, button{width:100%; max-width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:14px;}
  button{background:#000; color:#ff0; font-weight:700; border:none; cursor:pointer; transition:.2s;}
  button:hover{background:#ff0; color:#000;}
  .hint{color:var(--muted); font-size:12px; margin-top:6px;}
  .status{border-radius:12px; padding:12px 14px; font-weight:700; display:flex; align-items:center; gap:10px; min-height:42px;}
  .ok{background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0;}
  .err{background:#fef2f2; color:#991b1b; border:1px solid #fecaca;}
  .warn{background:#fffbeb; color:#92400e; border:1px solid #fde68a;}
  .grid{width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed;}
  .grid th,.grid td{border-bottom:1px solid #e5e7eb; padding:8px 10px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700;}
  .pill-ok{background:#d1fae5; color:#065f46;} .pill-dup{background:#fee2e2; color:#991b1b;}
  .controls{display:flex; gap:10px; flex-wrap:wrap;}
  #video{width:100%; border-radius:12px; background:#111; aspect-ratio:16/9; object-fit:cover;}
  .muted{color:var(--muted);} .small{font-size:12px;}
  .hidden{display:none !important;}
  .count{font-weight:700;}
</style>
</head>
<body>
<header>
  <h1>Validació QR — La Nit</h1>
  <div class="muted small">Enllaça un Google Sheets (vista) · Columna de codi: <strong>ID</strong> · Marca check-in al full</div>
</header>
<main>

  <div class="panel">
    <div class="row">
      <div>
        <label>URL del Google Sheets (vista, compartit amb “Qui tinga l’enllaç”)</label>
        <input type="text" id="sheetUrl" placeholder="Ex.: https://docs.google.com/spreadsheets/d/ID/edit?usp=sharing">
        <div class="controls" style="margin-top:8px;">
          <button id="loadSheetBtn">Carrega</button>
          <button id="refreshBtn" disabled>Actualitza</button>
        </div>
        <div class="hint">Si el full té diverses pestanyes, afegeix <code>&gid=...</code> a l'URL per escollir-ne una.</div>
      </div>
      <div>
        <label>Resum</label>
        <div id="summary" class="status warn">Esperant URL…</div>
        <div class="hint"><span class="count" id="countOk">0</span> validats · <span class="count" id="countTotal">0</span> totals</div>
      </div>
    </div>
    <div id="fallbackSelector" class="row hidden" style="margin-top:12px;">
      <div>
        <label>Columna de codi (fallback)</label>
        <select id="codeColumn"></select>
        <div class="hint">Només apareix si no es detecta la columna <strong>ID</strong>.</div>
      </div>
      <div>
        <label>Columna de check-in (fallback)</label>
        <select id="checkinColumn"></select>
        <div class="hint">Per defecte s'usa <strong>checkin</strong> si existeix.</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>Escaneig amb càmera</label>
        <video id="video" playsinline></video>
        <div class="controls" style="margin-top:10px;">
          <button id="startBtn" disabled>Inicia càmera</button>
          <button id="stopBtn" disabled>Para</button>
        </div>
        <div class="hint">HTTPS obligatori (GitHub Pages ho és).</div>
      </div>
      <div>
        <label>Entrada manual (rescat)</label>
        <input type="text" id="manualCode" placeholder="Escriu o enganxa codi i prem Enter">
        <div class="status warn" id="scanStatus">Esperant…</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>Últims escanejos</label>
        <table class="grid" id="recentTable">
          <thead><tr><th style="width:90px">Hora</th><th style="width:170px">Codi</th><th>Nom</th><th>Email</th><th style="width:70px">Estat</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display:none;"></canvas>
</main>

<script>
/* ======= CONFIGURA AÇÒ: Apps Script Web App que marca check-in =======
   1) Obre el teu Google Sheets.
   2) Extensions -> Apps Script -> crea un projecte, enganxa el codi que t'he posat en el missatge.
   3) Publica com a Web App: "Qualsevol amb l'enllaç" pot executar.
   4) Copia l'URL de desplegament i posa'l ací: */
const APP_SCRIPT_ENDPOINT = "https://script.google.com/macros/s/AKfycbzx3cQDgiehLZVDnJSPFdOkwgmaMZbnKAeH9xHIgTqhhb1q55JaLTSp8gln9mtwD86zgw/exec";
// Clau opcional per evitar abusos (ha d'anar igual en l'script)
const APP_SECRET = "canvia_açò_si_vols";

/* ======= Càmera (BarcodeDetector) ======= */
let BarcodeReady = ('BarcodeDetector' in window);
let detector = null;
if (BarcodeReady) {
  try { detector = new BarcodeDetector({formats: ['qr_code']}); } catch(e){ BarcodeReady = false; }
}

/* ======= Estat de dades ======= */
let rows = [], header = [], codeKey = 'ID', checkinKey = 'checkin';
const validMap = new Map(); // code -> {row, checked, rowIndex}
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let stream = null, loopId = null;

const summary = document.getElementById('summary');
const scanStatus = document.getElementById('scanStatus');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const manualCode = document.getElementById('manualCode');
const recentTable = document.querySelector('#recentTable tbody');
const loadSheetBtn = document.getElementById('loadSheetBtn');
const refreshBtn = document.getElementById('refreshBtn');
const sheetUrlInput = document.getElementById('sheetUrl');
const fallbackSelector = document.getElementById('fallbackSelector');
const codeColumn = document.getElementById('codeColumn');
const checkinColumn = document.getElementById('checkinColumn');
const countOk = document.getElementById('countOk');
const countTotal = document.getElementById('countTotal');

let lastCsvUrl = null;

/* ======= Helpers ======= */
function toCSVFromSheet(viewUrl){
  // Converteix una URL de visualització de Sheets a export CSV (mateix gid)
  if(!viewUrl) return null;
  const m = viewUrl.match(/^https:\/\/docs\.google\.com\/spreadsheets\/d\/([^\/]+)(?:\/.*)?$/);
  if(!m) return null;
  const id = m[1];
  const gidMatch = viewUrl.match(/[?&]gid=(\d+)/);
  const gid = gidMatch ? gidMatch[1] : '0';
  return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
}

async function loadCSVByUrl(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text = await res.text();
  parseCSV(text);

  // Detecta 'ID' i 'checkin' si existeixen
  const norm = h => h.trim().toLowerCase();
  const hasID = header.some(h => norm(h) === 'id');
  const hasCheck = header.some(h => norm(h) === 'checkin');
  if(hasID){ codeKey = header.find(h => norm(h) === 'id'); }
  if(hasCheck){ checkinKey = header.find(h => norm(h) === 'checkin'); }

  if(!hasID || !hasCheck){
    // mostra selectors fallback
    fallbackSelector.classList.remove('hidden');
    codeColumn.innerHTML = '';
    checkinColumn.innerHTML = '';
    header.forEach(h=>{
      const opt1=document.createElement('option'); opt1.value=h; opt1.textContent=h; codeColumn.appendChild(opt1);
      const opt2=document.createElement('option'); opt2.value=h; opt2.textContent=h; checkinColumn.appendChild(opt2);
    });
    if(hasID) codeColumn.value = codeKey;
    if(hasCheck) checkinColumn.value = checkinKey;
    codeColumn.onchange = ()=>{ codeKey = codeColumn.value; buildMap(); updateSummary(); };
    checkinColumn.onchange = ()=>{ checkinKey = checkinColumn.value; buildMap(); updateSummary(); };
  } else {
    fallbackSelector.classList.add('hidden');
  }

  buildMap(); updateSummary();
  startBtn.disabled = false; refreshBtn.disabled = false;
}

function parseCSV(text){
  rows = []; header = [];
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
  if(!lines.length) return;
  header = splitCSVLine(lines[0]);
  for(let i=1;i<lines.length;i++){
    const vals = splitCSVLine(lines[i]);
    const obj = {};
    for(let j=0;j<header.length;j++){ obj[header[j]] = (vals[j] ?? '').trim(); }
    rows.push(obj);
  }
}
function splitCSVLine(line){
  const out = []; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c=='"'){ if(inQ && line[i+1]=='"'){cur+='"'; i++;} else {inQ=!inQ;} }
    else if(c==',' && !inQ){ out.push(cur); cur=''; }
    else { cur+=c; }
  }
  out.push(cur); return out;
}

function buildMap(){
  validMap.clear();
  let ok=0;
  for(let idx=0; idx<rows.length; idx++){
    const r = rows[idx];
    const code = (r[codeKey] || '').trim();
    if(!code) continue;
    const checked = (String(r[checkinKey]||'').trim() === '1');
    if(checked) ok++;
    validMap.set(code, {row:r, checked, rowIndex: idx+2 /* +1 header +1 1-based */});
  }
  countOk.textContent = ok;
  countTotal.textContent = validMap.size;
}

function updateSummary(msg){
  if(!msg){ msg = `Càrrega correcta · ${validMap.size} codis · Columna ID: ${codeKey} · Check-in: ${checkinKey}`; }
  summary.className='status ok';
  summary.textContent = msg;
}

/* ======= UI events ======= */
document.getElementById('loadSheetBtn').addEventListener('click', async ()=>{
  const v = sheetUrlInput.value.trim();
  if(!v){ alert('Posa l’enllaç de visualització del Google Sheets.'); return; }
  const csvUrl = toCSVFromSheet(v);
  if(!csvUrl){ alert('Enllaç de Google Sheets no vàlid.'); return; }
  lastCsvUrl = csvUrl;
  try{
    await loadCSVByUrl(csvUrl);
  }catch(e){
    alert('No s’ha pogut carregar el full. Comprova que “Qui tinga l’enllaç” pot veure’l.'); console.error(e);
  }
});
document.getElementById('refreshBtn').addEventListener('click', async ()=>{
  if(!lastCsvUrl){ alert('Carrega abans un full.'); return; }
  try{
    await loadCSVByUrl(lastCsvUrl);
    updateSummary('Dades refrescades des del full.');
  }catch(e){
    alert('No s’ha pogut refrescar el full.'); console.error(e);
  }
});

/* ======= Escaneig ======= */
async function startCamera(){
  if(stream) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    await video.play();
    startBtn.disabled = true; stopBtn.disabled = false; scanLoop();
  }catch(e){ alert('No s’ha pogut iniciar la càmera. HTTPS i permisos necessaris.'); }
}
function stopCamera(){
  if(loopId){ cancelAnimationFrame(loopId); loopId=null; }
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  stopBtn.disabled = true; startBtn.disabled = false;
}
startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);

async function scanLoop(){
  if(!video.videoWidth){ loopId=requestAnimationFrame(scanLoop); return; }
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  let code=null;
  if(('BarcodeDetector' in window) && detector){
    try{
      const barcodes = await detector.detect(canvas);
      if(barcodes && barcodes.length){ code = (barcodes[0].rawValue || '').trim(); }
    }catch(e){}
  }
  if(code){ await handleCode(code); }
  loopId = requestAnimationFrame(scanLoop);
}

manualCode.addEventListener('keydown', async e=>{
  if(e.key==='Enter'){ e.preventDefault(); await handleCode(manualCode.value); manualCode.select(); }
});

/* ======= Validació i marcatge al full (via Apps Script) ======= */
async function handleCode(codeRaw){
  const code = String(codeRaw||'').trim();
  if(!code) return;
  const rec = validMap.get(code);
  const now = new Date();
  if(!rec){
    scanStatus.className='status err'; scanStatus.textContent='No trobat · '+code;
    addRecent(now, code, {Nom:'',Email:''}, 'bad');
    return;
  }
  if(rec.checked){
    scanStatus.className='status warn'; scanStatus.textContent='Ja validat · '+code;
    addRecent(now, code, rec.row, 'dup');
    return;
  }
  // marca via Apps Script
  try{
    const payload = {
      id: code,
      rowIndex: rec.rowIndex,   // 1-based row index al full
      sheetUrl: sheetUrlInput.value.trim(),
      secret: APP_SECRET
    };
    const res = await fetch(APP_SCRIPT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const data = await res.json();
    if(data && data.ok){
      rec.checked = true;
      rec.row[checkinKey] = '1';
      countOk.textContent = String(Number(countOk.textContent||'0') + 1);
      scanStatus.className='status ok'; scanStatus.textContent='VALIDAT · '+code;
      addRecent(now, code, rec.row, 'ok');
    }else if(data && data.msg==='already'){
      rec.checked = true;
      scanStatus.className='status warn'; scanStatus.textContent='Ja validat (full) · '+code;
      addRecent(now, code, rec.row, 'dup');
    }else{
      throw new Error('Resposta no vàlida de l’endpoint');
    }
  }catch(e){
    console.error(e);
    scanStatus.className='status err'; scanStatus.textContent='Error marcant al full · '+code;
    addRecent(now, code, rec.row, 'bad');
  }
}

function addRecent(date, code, row, kind){
  const tr=document.createElement('tr');
  const name = row?.Nom || row?.nom || row?.FirstName || row?.first_name || '';
  const email = row?.Email || row?.email || '';
  tr.innerHTML = `<td>${date.toLocaleTimeString()}</td><td>${code}</td>
                  <td>${escapeHtml(name)}</td><td>${escapeHtml(email)}</td><td>${statusPill(kind)}</td>`;
  recentTable.prepend(tr);
  while(recentTable.children.length>20){ recentTable.removeChild(recentTable.lastChild); }
}
function statusPill(kind){
  if(kind==='ok') return '<span class="pill pill-ok">OK</span>';
  if(kind==='dup') return '<span class="pill pill-dup">DUP</span>';
  return '<span class="pill" style="background:#fee2e2;color:#991b1b;">N/D</span>';
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
</script>
</body>
</html>
